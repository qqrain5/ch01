<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Guard - 專注力守護者</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .focus-mode {
            background-color: #064e3b; /* 深綠色 */
            color: #ecfdf5;
        }
        .timer-glow {
            box-shadow: 0 0 50px rgba(52, 211, 153, 0.2);
        }
        .transition-all-700 {
            transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .ripple {
            position: absolute;
            border: 2px solid rgba(52, 211, 153, 0.5);
            border-radius: 50%;
            animation: ripple 2s infinite;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen transition-all-700 overflow-hidden" id="body">

    <!-- 授權遮罩 (iOS/Android 權限請求) -->
    <div id="permissionOverlay" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="bg-emerald-100 w-20 h-20 rounded-3xl flex items-center justify-center mb-8">
            <i class="fa-solid fa-mobile-screen-button text-4xl text-emerald-600"></i>
        </div>
        <h1 class="text-3xl font-black text-slate-900 mb-4">Focus Guard</h1>
        <p class="text-slate-500 mb-10 max-w-xs leading-relaxed">
            我們需要存取您的<b>方向感測器</b>。<br>當您將手機翻面朝下時，將會自動開啟專注模式。
        </p>
        <button id="startBtn" class="w-full max-w-xs bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl shadow-xl shadow-emerald-100 transition-all active:scale-95">
            啟動監測模式
        </button>
        <button id="simModeBtn" class="mt-4 text-xs text-slate-400 underline uppercase tracking-widest">
            在電腦上測試 (模擬模式)
        </button>
    </div>

    <!-- 主要介面 -->
    <main class="flex flex-col items-center justify-center min-h-screen p-6 relative">
        
        <!-- 狀態標示 -->
        <div id="statusSection" class="text-center mb-12">
            <div id="statusIcon" class="mb-4 text-5xl text-amber-500">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h2 id="statusText" class="text-2xl font-black uppercase tracking-widest">準備專注？</h2>
            <p id="statusDesc" class="text-slate-400 text-sm mt-2">請將手機螢幕朝下放置</p>
        </div>

        <!-- 計時器主圓圈 -->
        <div class="relative flex items-center justify-center mb-12">
            <div id="rippleContainer" class="hidden items-center justify-center">
                <div class="ripple w-64 h-64"></div>
                <div class="ripple w-64 h-64" style="animation-delay: 1s"></div>
            </div>
            <div id="timerCircle" class="w-64 h-64 rounded-full bg-white border-8 border-slate-100 flex flex-col items-center justify-center shadow-xl transition-all-700 z-10">
                <span id="timeDisplay" class="text-5xl font-mono font-black tracking-tighter">00:00</span>
                <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mt-2">Focus Time</span>
            </div>
        </div>

        <!-- 統計數據 -->
        <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
            <div class="bg-white/10 backdrop-blur rounded-3xl p-6 border border-white/10 shadow-sm" id="statAward">
                <div class="flex items-center gap-2 mb-2 opacity-60">
                    <i class="fa-solid fa-award text-amber-400"></i>
                    <span class="text-[10px] font-bold uppercase tracking-widest">成就時數</span>
                </div>
                <p class="text-2xl font-black"><span id="focusMin">0</span> <small class="text-sm font-normal opacity-60">MIN</small></p>
            </div>
            <div class="bg-white/10 backdrop-blur rounded-3xl p-6 border border-white/10 shadow-sm" id="statDistract">
                <div class="flex items-center gap-2 mb-2 opacity-60">
                    <i class="fa-solid fa-bolt text-red-400"></i>
                    <span class="text-[10px] font-bold uppercase tracking-widest">分心次數</span>
                </div>
                <p class="text-2xl font-black"><span id="distractCount">0</span> <small class="text-sm font-normal opacity-60">次</small></p>
            </div>
        </div>

        <!-- 重置按鈕 -->
        <button id="resetBtn" class="mt-10 text-xs font-bold uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity">
            <i class="fa-solid fa-rotate-right mr-1"></i> 重置今日紀錄
        </button>

    </main>

    <!-- 模擬控制面板 (僅模擬模式顯示) -->
    <div id="simControl" class="fixed bottom-6 left-6 right-6 bg-white p-6 rounded-3xl shadow-2xl border border-emerald-100 hidden">
        <div class="flex justify-between mb-4">
            <span class="text-xs font-bold text-emerald-600 uppercase">模擬手機翻轉角度 (Beta)</span>
            <span id="betaVal" class="text-xs font-mono">0°</span>
        </div>
        <input type="range" id="simSlider" min="-180" max="180" value="0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600">
        <div class="flex justify-between text-[10px] text-slate-400 mt-2 font-mono">
            <span>面朝上 (0°)</span>
            <span>面朝下 (±180°)</span>
        </div>
    </div>

    <script>
        // --- 變數宣告 ---
        const body = document.getElementById('body');
        const overlay = document.getElementById('permissionOverlay');
        const startBtn = document.getElementById('startBtn');
        const simModeBtn = document.getElementById('simModeBtn');
        const simControl = document.getElementById('simControl');
        const simSlider = document.getElementById('simSlider');
        const betaValDisplay = document.getElementById('betaVal');

        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const statusDesc = document.getElementById('statusDesc');
        const timerCircle = document.getElementById('timerCircle');
        const timeDisplay = document.getElementById('timeDisplay');
        const rippleContainer = document.getElementById('rippleContainer');

        const focusMinEl = document.getElementById('focusMin');
        const distractCountEl = document.getElementById('distractCount');
        const resetBtn = document.getElementById('resetBtn');

        let isFaceDown = false;
        let seconds = 0;
        let distractions = 0;
        let timer = null;
        let isMonitoring = false;

        // --- 核心逻辑 ---

        function updateState(faceDown) {
            if (isFaceDown === faceDown) return;
            isFaceDown = faceDown;

            if (isFaceDown) {
                // 進入專注模式
                body.classList.add('focus-mode');
                statusIcon.innerHTML = '<i class="fa-solid fa-hourglass-start"></i>';
                statusIcon.className = 'mb-4 text-5xl text-emerald-400 animate-pulse';
                statusText.innerText = '深度專注中...';
                statusText.className = 'text-2xl font-black uppercase tracking-widest text-emerald-100';
                statusDesc.innerText = '請保持螢幕朝下，遠離干擾';
                timerCircle.className = 'w-64 h-64 rounded-full bg-emerald-800/50 border-8 border-emerald-400 flex flex-col items-center justify-center timer-glow transition-all-700 z-10';
                rippleContainer.classList.replace('hidden', 'flex');
                
                startTimer();
            } else {
                // 退出專注模式 (分心)
                body.classList.remove('focus-mode');
                statusIcon.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>';
                statusIcon.className = 'mb-4 text-5xl text-amber-500';
                statusText.innerText = '準備專注？';
                statusText.className = 'text-2xl font-black uppercase tracking-widest text-slate-800';
                statusDesc.innerText = '請將手機螢幕朝下放置';
                timerCircle.className = 'w-64 h-64 rounded-full bg-white border-8 border-slate-100 flex flex-col items-center justify-center shadow-xl transition-all-700 z-10';
                rippleContainer.classList.replace('flex', 'hidden');

                if (seconds > 0) {
                    distractions++;
                    distractCountEl.innerText = distractions;
                    logFocusData(seconds); // 模擬 Fetch 回傳
                }
                stopTimer();
            }
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                seconds++;
                renderTime();
                focusMinEl.innerText = Math.floor(seconds / 60);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timer);
        }

        function renderTime() {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            timeDisplay.innerText = `${m}:${s}`;
        }

        async function logFocusData(duration) {
            console.log(`[Fetch] 專注結束。時長：${duration}秒，累計分心：${distractions}次`);
            // 實作時可加入 exponential backoff 邏輯與 API 串接
        }

        // --- 感測器與事件 ---

        async function initSensor() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        activateMonitoring();
                    } else {
                        alert("需要感測器權限才能運作。");
                    }
                } catch (e) { console.error(e); }
            } else {
                activateMonitoring();
            }
        }

        function activateMonitoring() {
            isMonitoring = true;
            overlay.style.display = 'none';
            window.addEventListener('deviceorientation', (event) => {
                // Beta 值表示前後傾斜。
                // 當手機平放面朝上，Beta 約為 0。
                // 當手機平放面朝下，Beta 約為 180 或 -180。
                const beta = Math.abs(event.beta);
                updateState(beta > 160);
            });
        }

        // --- 控制按鈕 ---

        startBtn.onclick = initSensor;

        simModeBtn.onclick = () => {
            overlay.style.display = 'none';
            simControl.classList.remove('hidden');
            isMonitoring = true;
        };

        simSlider.oninput = (e) => {
            const val = e.target.value;
            betaValDisplay.innerText = `${val}°`;
            if (isMonitoring) {
                updateState(Math.abs(val) > 160);
            }
        };

        resetBtn.onclick = () => {
            seconds = 0;
            distractions = 0;
            renderTime();
            focusMinEl.innerText = '0';
            distractCountEl.innerText = '0';
        };

    </script>
</body>
</html>